{
    "contents" : "library(GenomicRanges)\nlibrary(plyr)\n\nmapping.intervals <- function(haps, ...) {\n\t\n\t## get disjoint intervals covering whole genome, within each of which no individual is recombinant\n\t\n\trez <- ldply(haps, function(h) ldply(h, as.data.frame),\n\t\t\t\t\t\t\t .progress = \"text\")\n\tgr <- makeGRangesFromDataFrame(rez[ ,c(\"seqnames\",\"start\",\"end\") ], ignore.strand = TRUE)\n\tbins <- disjoin(gr)\n\treturn(bins)\n\t\n}\n\ncalc.hap.dosage <- function(haps, bins, alleles = NULL, mode = \"additive\", ...) {\n\t\n\t## returns 3d array: samples x bins x strains\n\t\n\tif (!(mode == \"additive\") | is.null(alleles))\n\t\tstop()\n\t\n\t.haps <- haps\n\t\n\thaps <- flatten.haplotypes(haps, \"parent\")\n\t# print(haps)\n\trez <- laply(haps, function(h) {\n\t\tolap <- as.data.frame(findOverlaps(bins, h))\n\t\tolap$strain <- h$strain[ olap$subjectHits ]\n\t\tolap$strain <- factor(olap$strain, levels = alleles)\n\t\tolap$bin <- factor(olap$queryHits, levels = 1:length(bins))\n\t\txtabs(~ bin + strain, olap)\n\t}, .progress = \"text\")\n\t\n\tattr(rez, \"intervals\") <- bins\n\treturn(rez)\n\t\n}\n\nhk.regress <- function(phe, gty, ...) {\n\t\n\t## given phenotype vector and haplotype-dosage matrix, do HK-style regressino\n\t\n\td <- data.frame(y = phe, as.data.frame(gty))\n\tm0 <- lm(y ~ 1, d)\n\tm1 <- lm(y ~ ., d)\n\t# print(summary(m1))\n\tn <- length(resid(m0))\n\trss0 <- sum(resid(m0)^2)\n\trss <- sum(resid(m1)^2)\n\tlod <- as.numeric(n/2)*log10(rss0/rss)\n\trez <- c(coef(m1), lod)\n\tnames(rez)[ length(rez) ] <- \"LOD\"\n\t\n\treturn(list(lod = lod, coef = coef(m1),\n\t\t\t\t\t\t\tn = n, df.resid = m1$df.resid))\n\t\n}\n\nmap.single.locus <- function(phe, gty, ...) {\n\t\n\t## run QTL scan on haplotype dosage object returned by calc.hap.dosage()\n\t\n\tlod <- aaply(gty, 2, function(x) {\n\t\trez <- hk.regress(phe, x)\n\t\treturn(rez$lod)\n\t}, .progress = \"text\")\n\t\n\tbins <- attr(gty, \"intervals\")\n\trez <- data.frame(chr = seqnames(bins), pos = mid(ranges(bins)), lod = lod)\n\treturn(rez)\n\t\n}",
    "created" : 1407887062245.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2876903356",
    "id" : "DFB7953A",
    "lastKnownWriteTime" : 1407887116,
    "path" : "C:/Users/Andrew Parker Morgan/Dropbox/pmdvlab/R_multiparental/R/qtl.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}